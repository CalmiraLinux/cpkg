# CPkg - Calmira Packages

## Введение

`cpkg` - автоматизированная система работы с пакетами для Calmira GNU/Linux. Она написана с нуля на `bash` и предоставляет базовые функции для установки и удаления пакетов.

Пакетным менеджером эту утилиту назвать пока ещё нельзя. Помимо отсутствия обработки зависимостей, в `cpkg` отсутствует множество функций, без которых не обходится ни один пакетный менеджер.

## Синтаксис

Установка ПО:
```bash
cpkg install $PACKAGE.txz
# или
cpkg -i $PACKAGE.txz
```

Удаление ПО:
```bash
cpkg remove $PACKAGE
# или
cpkg -r $PACKAGE
```

## Дополнительные опции
О работе с дополнительными опциями написано в инструкции:
```bash
cpkg help
```

## Создание бинарного пакета для `cpkg`
Пакет для `cpkg` представляет собой tar архив, сжатый методом `xz`. В архиве находится директория PKG, в которой находятся файлы `config.sh`, `preinst.sh` (опционально), `postinst.sh` (опционально), а так же директория `pkg`, в которой находится сам пакет. Дерево каталогов пакета должно совпадать с деревом каталогов операционной системы.

**Назначение файлов и директорий:**
* `PKG` - в этой директории находятся сам пакет и файлы описания, а так же файлы пред- и послеустановочных настроек.
* `PKG/pkg` - директория с пакетом
* `PKG/config.sh` - описание пакета
* `PKG/preinst.sh` - скрипт, выполняющийся до установки пакета. Может быть полезен для настройки системы или окружения перед установкой пакета. Наличие этого файла ***опционально***
* `PKG/postinst.sh` - скрипт, выполняющийся после установки пакета. Может быть полезен для настройки пакета. Наличие этого файла ***опционально***

Тогда дерево каталогов пакета будет примерно таким:
```
|--- some_package.txz
|   |--- PKG
|       |--- config.sh
|       |--- {post,pre}inst.sh
|       |--- pkg
|           |--- usr
|           |--- etc
|           |--- var
|           |--- ...
```

В случае, если это метапакет или пакет с исходным кодом, в директории `PKG` наличие файла `port.sh` **обязательно**. В нём описываются инструкции по сборке и установке пакета.

Наличие шебанга обязательно:
```bash
#!/bin/bash
```

Пример:
```bash
#!/bin/bash

cd /var/cache/cpkg/archives	# Переход в рабочую директорию
wget https://www.some.site/some_package.tar.gz	# Скачивание пакета some_package.tar.gz с сайта https://www.some.site
tar -xvf some_package.tar.gz	# Распаковка пакета с исходным кодом

cd some_package
./configure --prefix=/usr \
	--bindir=/usr/bin \
	--sysconfdir=/etc	# Конфигурирование пакета
make		# Сборка
make install	# Установка
```

### Строение файла `config.sh`
В этом файле описывается сам пакет. В нём указывается имя пакета, версия, мейнтейнер, описание и файлы пакета.
Пример такого файла:
```bash
NAME=some_package
VERSION=1.0
MAINTAINER="Linuxoid85 <linuxoid85@gmail.com>"
DESCRIPTION="Some package for test cpkg package manager"
FILES="/usr/bin/{some_pkg,test_cpkg} /usr/share/some_pkg/"
```

**Описание переменных:**
* `NAME` - имя пакета
* `VERSION` - версия пакета/программы
* `MAINTAINER` - сборщик (сопровождающий) пакета
* `DESCRIPTION` - описание пакета
* `FILES` - все файлы пакета.

Если в одной директории (чаще всего это `/bin`, `/usr/bin`, `/etc` и пр.) несколько файлов из пакета, то нет смысла дублировать пути до этих файлов. Проще объединить их в массив. К примеру, есть директория `/usr/bin`, в которую устанавливаются файлы `some_pkg` и `test_cpkg`. В строке `FILES="..."` они объединены в массив `/usr/bin/{some_pkg,test_cpkg}`. То есть, файлы перечисляются в фигурных скобках {}.

Так же, все отдельные файлы разделяются между собой пробелами.

### Строение файлов `post-` и `preinst.sh`
Как было сказано выше, первый файл выполняется до установки пакета, а второй - после. Они нужны для настройки окружения или системы (до установки) и пакета (после установки). Эти файлы - BASH-скрипты.

> Шебанг `#!/bin/bash` обязателен.

В этих скриптах доступны все команды `bash`.

## Зависимости
* `bash`
* `coreutils`
* `calmira scripts` (опционально; в разработке)

***
На этом руководство по использованию `cpkg` окончено.

Удачи!
